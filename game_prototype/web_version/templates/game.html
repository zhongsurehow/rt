<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>天机变 - 游戏中</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/game.css">
    <style>
        /* 融合三个文件的优秀设计元素 */
        
        /* 新的九宫格样式 */
        .jiugongge-position {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            color: #fff;
        }
        
        .jiugongge-position:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(255, 215, 0, 0.4);
            background: rgba(255, 215, 0, 0.1);
            border-color: rgba(255, 215, 0, 0.6);
        }

        .jiugongge-center {
            background: rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 215, 0, 0.4);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            color: #fff;
        }

        .bagua-symbol {
            font-size: 3rem; /* 48px */
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        
        .bagua-name {
            font-size: 1.125rem; /* 18px */
            font-weight: bold;
        }

        .bagua-element {
            font-size: 0.875rem; /* 14px */
            color: rgba(255, 255, 255, 0.7);
        }

        .taiji-symbol {
            font-size: 4rem; /* 64px */
            animation: taijRotate 120s linear infinite;
        }

        @keyframes taijRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .center-text {
            font-size: 1rem; /* 16px */
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
        }

        /* 动画效果 - 参考tianjibian_game_simulation.html */
        .card-draw-animation {
            animation: cardDraw 0.5s ease-out;
        }

        @keyframes cardDraw {
            0% { transform: scale(0) rotate(180deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(90deg); opacity: 0.7; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .pulse-effect {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        /* 玩家头像样式 */
        .player-avatar {
            position: absolute;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            border: 3px solid rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            z-index: 15;
            transition: all 0.3s ease;
            top: -16px;
            right: -16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .player-avatar:hover {
            transform: scale(1.3);
            border-color: rgba(255, 215, 0, 1);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
        }

        /* 四人对战专用样式 */
        .four-player-mode .player-avatar {
            width: 36px;
            height: 36px;
            font-size: 16px;
            border-width: 3px;
            top: -18px;
            right: -18px;
        }

        /* 玩家位置指示器 */
        .player-position-indicator {
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            z-index: 20;
            white-space: nowrap;
        }

        /* 当前玩家高亮 */
        .current-player-position {
            animation: currentPlayerPulse 2s ease-in-out infinite;
        }

        @keyframes currentPlayerPulse {
            0%, 100% { 
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
                border-color: rgba(255, 215, 0, 0.8);
            }
            50% { 
                box-shadow: 0 0 25px rgba(255, 215, 0, 1);
                border-color: rgba(255, 215, 0, 1);
                transform: scale(1.1);
            }
        }

        /* 四人对战模式优化样式 */
        .four-player-battle-mode .bagua-container {
            transform: scale(1.1);
            margin: 20px auto;
        }

        .four-player-battle-mode .bagua-position {
            width: 90px;
            height: 90px;
            border: 3px solid rgba(255, 215, 0, 0.8);
        }

        .four-player-battle-mode .bagua-position:hover {
            transform: scale(1.15);
            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.6);
        }

        .four-player-battle-mode .current-player-position .player-position-indicator {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            border: 1px solid #ff6b6b;
            color: white;
            font-weight: bold;
        }

        /* 日志系统样式 - 参考tianjibian_game_simulation.html */
        .game-log {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.important {
            color: #ffd700;
            font-weight: bold;
        }

        /* 卡牌游戏样式 */
        .card-game-board {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            backdrop-filter: blur(10px);
        }

        .board-cell {
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .board-cell:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.02);
        }

        .card-on-board {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(147, 51, 234, 0.3));
            border-radius: 8px;
            padding: 8px;
        }

        .card-in-hand {
            min-width: 150px;
            max-width: 200px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .card-in-hand:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .empty-cell {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 8px;
        }

        /* 卡牌动画效果 */
        .card-play-animation {
            animation: cardPlay 0.6s ease-out;
        }

        @keyframes cardPlay {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        /* 选中效果 */
        .selected-card {
            border-color: #ffd700 !important;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .selected-position {
            border-color: #ffd700 !important;
            background: rgba(255, 215, 0, 0.1) !important;
        }

        /* 反馈系统样式 */
        .feedback-message {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            animation: slideInRight 0.3s ease-out;
            max-width: 300px;
            word-wrap: break-word;
        }

        .feedback-message.success {
            background: linear-gradient(135deg, #10b981, #059669);
            border-left: 4px solid #34d399;
        }

        .feedback-message.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-left: 4px solid #f87171;
        }

        .feedback-message.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-left: 4px solid #fbbf24;
        }

        .feedback-message.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-left: 4px solid #60a5fa;
        }

        .feedback-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.7;
        }

        .feedback-close:hover {
            opacity: 1;
        }

        /* 确认对话框样式 */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            animation: fadeIn 0.3s ease-out;
        }

        .confirm-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: scaleIn 0.3s ease-out;
        }

        .confirm-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .confirm-message {
            color: #6b7280;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .confirm-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .confirm-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .confirm-btn.cancel {
            background: #f3f4f6;
            color: #374151;
        }

        .confirm-btn.cancel:hover {
            background: #e5e7eb;
        }

        .confirm-btn.confirm {
            background: #3b82f6;
            color: white;
        }

        .confirm-btn.confirm:hover {
            background: #2563eb;
        }

        /* 操作提示样式 */
        .action-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 999;
            animation: slideInUp 0.3s ease-out;
            max-width: 400px;
            text-align: center;
        }

        /* 状态指示器样式 */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-indicator.connected {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status-indicator.connecting {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            animation: pulse 2s infinite;
        }

        .status-indicator.disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* 动画效果 */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInUp {
            from {
                transform: translateX(-50%) translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Card Codex Modal Styles */
        .codex-modal {
            position: fixed;
            z-index: 1002; /* Higher than other elements */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .codex-modal-content {
            background: rgba(17, 24, 39, 0.9); /* bg-gray-900 with opacity */
            backdrop-filter: blur(10px);
            margin: auto;
            padding: 24px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            width: 90%;
            max-width: 1400px;
            border-radius: 12px;
            color: #fff;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .codex-close-btn {
            color: #aaa;
            position: absolute;
            top: 16px;
            right: 24px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        .codex-close-btn:hover {
            color: #fff;
        }

        .codex-tabs {
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .codex-tab-link {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 1px solid transparent;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 6px;
            margin-right: 10px;
        }

        .codex-tab-link.active, .codex-tab-link:hover {
            background: #ffd700;
            color: #000;
            border-color: #ffd700;
        }

        .codex-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 10px; /* For scrollbar */
        }

        .codex-card {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 13px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .codex-card .card-name { font-weight: bold; color: #ffd700; font-size: 16px; }
        .codex-card .card-type { font-size: 12px; color: #ccc; margin-top: 4px; }
        .codex-card .card-desc { font-size: 13px; margin-top: 8px; flex-grow: 1; }
        .codex-card .card-cost-power { font-size: 12px; margin-top: 8px; color: #88aaff; }

        /* Tutorial Highlight */
        .tutorial-highlight {
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.7), 0 0 20px 10px rgba(59, 130, 246, 0.5);
            border-radius: 12px; /* A bit larger to be more visible */
            transition: all 0.3s ease-in-out;
            position: relative;
            z-index: 51; /* Higher than the overlay backdrop */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-800 min-h-screen">
    <div id="app" class="min-h-screen flex flex-col four-player-battle-mode">
        <!-- 顶部导航 -->
        <nav class="bg-black/20 backdrop-blur-md border-b border-white/10 p-4">
            <div class="max-w-7xl mx-auto">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold text-white">天机变 - 四人对战</h1>
                        <div class="text-white/70">
                            <span v-if="gameState">游戏ID: [[ gameState.game_id ]]</span>
                            <span v-else class="text-red-400">游戏状态未加载</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-white/70">
                            <span v-if="connectionStatus.connected" class="text-green-400">
                                <i class="fas fa-circle text-xs"></i> 已连接
                            </span>
                            <span v-else class="text-red-400">
                                <i class="fas fa-circle text-xs"></i> 连接中...
                            </span>
                        </div>
                        <button @click="leaveGame" class="text-white/70 hover:text-white">
                            <i class="fas fa-sign-out-alt"></i> 离开
                        </button>
                    </div>
                </div>
                
                <!-- 详细游戏状态显示 -->
                <div class="grid grid-cols-8 gap-4 text-sm">
                    <div class="text-center">
                        <div class="text-white/70 text-xs">当前回合</div>
                        <div class="text-white font-medium" id="current-round">[[ currentRound ]]</div>
                    </div>
                    <div class="text-center">
                        <div class="text-white/70 text-xs">当前玩家</div>
                        <div class="text-yellow-400 font-medium" id="current-player">[[ getCurrentPlayerName() ]]</div>
                    </div>
                    <div class="text-center">
                        <div class="text-white/70 text-xs">当前季节</div>
                        <div class="text-green-400 font-medium" id="current-season">[[ getCurrentSeason() ]]</div>
                    </div>
                    <div class="text-center">
                        <div class="text-white/70 text-xs">五行主导</div>
                        <div class="text-orange-400 font-medium" id="current-wuxing">[[ getCurrentWuxing() ]]</div>
                    </div>
                    <div class="text-center">
                        <div class="text-white/70 text-xs">天干地支</div>
                        <div class="text-purple-400 font-medium" id="current-ganzhi">[[ getCurrentGanzhi() ]]</div>
                    </div>
                    <div class="text-center">
                        <div class="text-white/70 text-xs">节气</div>
                        <div class="text-cyan-400 font-medium" id="current-jieqi">[[ getCurrentJieqi() ]]</div>
                    </div>
                    <div class="text-center">
                        <div class="text-white/70 text-xs">阴阳</div>
                        <div class="text-yellow-400 font-medium" id="current-yinyang">[[ getCurrentYinyang() ]]</div>
                    </div>
                    <div class="text-center">
                        <div class="text-white/70 text-xs">游戏状态</div>
                        <div class="text-blue-400 font-medium" id="game-state">[[ getCurrentGameState() ]]</div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 主游戏区域 -->
        <div class="flex-1 flex">
            <!-- 左侧玩家信息 -->
            <div class="w-80 bg-black/20 backdrop-blur-md border-r border-white/10 p-6">
                <!-- 当前玩家状态 -->
                <div class="mb-6">
                    <h3 class="text-white font-semibold mb-4">玩家状态</h3>
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div>
                                <div class="text-white font-medium">
                                    <span v-if="activePlayer">[[ activePlayer.name || '玩家' ]]</span>
                                    <span v-else>等待玩家...</span>
                                </div>
                                <div class="text-white/70 text-sm">
                                    <span v-if="isMyTurn">你的回合</span>
                                    <span v-else>等待中</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 属性值 -->
                        <div class="space-y-3" :class="{'tutorial-highlight': tutorialStep === 4}">
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-white/70">气</span>
                                    <span v-if="activePlayer">[[ activePlayer.qi || 0 ]]/100</span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-2">
                                    <div class="bg-blue-400 h-2 rounded-full" :style="{width: (activePlayer?.qi || 0) + '%'}"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-white/70">道</span>
                                    <span v-if="activePlayer">[[ activePlayer.dao || 0 ]]/100</span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-2">
                                    <div class="bg-purple-400 h-2 rounded-full" :style="{width: (activePlayer?.dao || 0) + '%'}"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-white/70">诚</span>
                                    <span v-if="activePlayer">[[ activePlayer.sincerity || 0 ]]/100</span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-2">
                                    <div class="bg-yellow-400 h-2 rounded-full" :style="{width: (activePlayer?.sincerity || 0) + '%'}"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 阴阳平衡 -->
                        <div class="mt-4 p-3 bg-white/5 rounded-lg">
                            <div class="text-white/70 text-sm mb-2">阴阳平衡</div>
                            <div class="text-white text-sm">
                                阴: <span v-if="activePlayer">[[ activePlayer.yin || 0 ]]</span><br>
                                阳: <span v-if="activePlayer">[[ activePlayer.yang || 0 ]]</span>
                            </div>
                        </div>

                        <!-- 五行元素 -->
                        <div class="mt-4">
                            <div class="text-white/70 text-sm mb-2">五行元素</div>
                            <div class="grid grid-cols-5 gap-2">
                                <div class="text-center">
                                    <div class="w-8 h-8 bg-green-500 rounded-full mx-auto mb-1"></div>
                                    <div class="text-white/70 text-xs">
                                        <span v-if="activePlayer && activePlayer.elements">[[ activePlayer.elements.wood || 0 ]]</span>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="w-8 h-8 bg-red-500 rounded-full mx-auto mb-1"></div>
                                    <div class="text-white/70 text-xs">
                                        <span v-if="activePlayer && activePlayer.elements">[[ activePlayer.elements.fire || 0 ]]</span>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="w-8 h-8 bg-yellow-500 rounded-full mx-auto mb-1"></div>
                                    <div class="text-white/70 text-xs">
                                        <span v-if="activePlayer && activePlayer.elements">[[ activePlayer.elements.earth || 0 ]]</span>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="w-8 h-8 bg-gray-400 rounded-full mx-auto mb-1"></div>
                                    <div class="text-white/70 text-xs">
                                        <span v-if="activePlayer && activePlayer.elements">[[ activePlayer.elements.metal || 0 ]]</span>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="w-8 h-8 bg-blue-500 rounded-full mx-auto mb-1"></div>
                                    <div class="text-white/70 text-xs">
                                        <span v-if="activePlayer && activePlayer.elements">[[ activePlayer.elements.water || 0 ]]</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 其他玩家 -->
                <div v-if="otherPlayers.length > 0">
                    <h3 class="text-white font-semibold mb-4">其他玩家</h3>
                    <div class="space-y-3">
                        <div v-for="player in otherPlayers" :key="player.id" class="bg-white/10 rounded-lg p-3">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-gradient-to-br from-gray-400 to-gray-600 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-user text-white text-sm"></i>
                                </div>
                                <div>
                                    <div class="text-white font-medium">[[ player.name ]]</div>
                                    <div class="text-white/70 text-xs">
                                        气: [[ player.qi ]] | 道: [[ player.dao ]]
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 新的教学功能入口 -->
                <div class="mt-6">
                    <h3 class="text-white font-semibold mb-4">游戏教学</h3>
                    <div class="bg-white/10 rounded-lg p-4 space-y-3">
                        <p class="text-white/70 text-sm">
                            不熟悉游戏规则？点击下方按钮开始互动教学。
                        </p>
                        <button @click="startTutorial" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-graduation-cap mr-2"></i>开始教学
                        </button>
                    </div>
                </div>

                <!-- 四人玩家信息 -->
                <div class="mt-6" v-if="players && players.length > 0">
                    <h3 class="text-white font-semibold mb-4">玩家状态</h3>
                    <div class="space-y-2">
                        <div v-for="(player, index) in players" :key="player.id" 
                             :class="currentPlayerIndex === index ? 'bg-blue-500/20 border border-blue-500/50' : 'bg-white/10'"
                             class="rounded-lg p-3">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-white font-medium text-sm">[[ player.name ]]</div>
                                    <div class="text-white/70 text-xs">
                                        [[ player.personality ]]
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-white/70 text-xs">
                                        健康: [[ player.health ]]
                                    </div>
                                    <div class="text-white/70 text-xs">
                                        能量: [[ player.energy ]]
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2 text-white/70 text-xs">
                                位置: [[ player.position ]] | 阴阳: [[ player.yin ]]/[[ player.yang ]]
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 中央游戏区域 -->
            <div class="flex-1 flex flex-col items-center justify-center p-6">
                <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 shadow-2xl w-full max-w-3xl aspect-square">
                    <h3 class="text-white font-semibold text-center mb-4 text-xl">天机变 - 九宫格棋盘</h3>

                    <!-- 后天八卦九宫格 -->
                    <div class="grid grid-cols-3 gap-3 h-full" :class="{'tutorial-highlight': tutorialStep === 2}">
                        <!-- Row 1: SE, S, SW -->
                        <div class="jiugongge-position" @click="selectBoardPosition(4)" :class="{'selected-position': selectedPosition === 4}" title="巽 (Xùn) - 风 (Wind)">
                            <div class="bagua-symbol text-green-400">☴</div>
                            <div class="bagua-name">巽</div>
                            <div class="bagua-element">东南</div>
                        </div>
                        <div class="jiugongge-position" @click="selectBoardPosition(9)" :class="{'selected-position': selectedPosition === 9}" title="离 (Lí) - 火 (Fire)">
                            <div class="bagua-symbol text-red-400">☲</div>
                            <div class="bagua-name">离</div>
                            <div class="bagua-element">南</div>
                        </div>
                        <div class="jiugongge-position" @click="selectBoardPosition(2)" :class="{'selected-position': selectedPosition === 2}" title="坤 (Kūn) - 地 (Earth)">
                            <div class="bagua-symbol text-yellow-400">☷</div>
                            <div class="bagua-name">坤</div>
                            <div class="bagua-element">西南</div>
                        </div>

                        <!-- Row 2: E, Center, W -->
                        <div class="jiugongge-position" @click="selectBoardPosition(3)" :class="{'selected-position': selectedPosition === 3}" title="震 (Zhèn) - 雷 (Thunder)">
                            <div class="bagua-symbol text-green-300">☳</div>
                            <div class="bagua-name">震</div>
                            <div class="bagua-element">东</div>
                        </div>
                        <div class="jiugongge-center" title="太极 (Taiji) - Center">
                            <div class="taiji-symbol">☯</div>
                            <div class="center-text">中宫</div>
                        </div>
                        <div class="jiugongge-position" @click="selectBoardPosition(7)" :class="{'selected-position': selectedPosition === 7}" title="兑 (Duì) - 泽 (Lake)">
                            <div class="bagua-symbol text-gray-300">☱</div>
                            <div class="bagua-name">兑</div>
                            <div class="bagua-element">西</div>
                        </div>

                        <!-- Row 3: NE, N, NW -->
                        <div class="jiugongge-position" @click="selectBoardPosition(8)" :class="{'selected-position': selectedPosition === 8}" title="艮 (Gèn) - 山 (Mountain)">
                            <div class="bagua-symbol text-yellow-500">☶</div>
                            <div class="bagua-name">艮</div>
                            <div class="bagua-element">东北</div>
                        </div>
                        <div class="jiugongge-position" @click="selectBoardPosition(1)" :class="{'selected-position': selectedPosition === 1}" title="坎 (Kǎn) - 水 (Water)">
                            <div class="bagua-symbol text-blue-400">☵</div>
                            <div class="bagua-name">坎</div>
                            <div class="bagua-element">北</div>
                        </div>
                        <div class="jiugongge-position" @click="selectBoardPosition(6)" :class="{'selected-position': selectedPosition === 6}" title="乾 (Qián) - 天 (Heaven)">
                            <div class="bagua-symbol text-gray-200">☰</div>
                            <div class="bagua-name">乾</div>
                            <div class="bagua-element">西北</div>
                        </div>
                    </div>
                </div>
            </div>

                <!-- 手牌区域 -->
                <div class="p-6 pt-0">
                    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-white font-semibold">手牌</h3>
                            <div class="text-white/70 text-sm">
                                <span v-if="playerHand">[[ playerHand.length ]] 张卡牌</span>
                            </div>
                        </div>
                        <div class="flex space-x-4 overflow-x-auto pb-2" :class="{'tutorial-highlight': tutorialStep === 3}">
                            <div v-for="(card, index) in playerHand" :key="card.id"
                                 @click="selectCard(card, index)"
                                 :class="['flex-shrink-0 w-40 h-56 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg p-3 cursor-pointer transition-all hover:scale-105 card-draw-animation',
                                         selectedCard?.id === card.id ? 'ring-2 ring-yellow-400 scale-105' : '']">
                                <div class="text-white text-center h-full flex flex-col justify-between">
                                    <div>
                                        <div class="font-bold text-sm mb-1">[[ card.name ]]</div>
                                        <div class="text-xs opacity-80 mb-1">
                                            [[ card.type ]]
                                            <span v-if="card.category" class="text-yellow-300">([[ card.category ]])</span>
                                        </div>
                                        <div class="text-xs mt-1 opacity-80 text-green-300">
                                            属性: [[ card.element ]]
                                        </div>
                                        <div class="text-xs mt-1 opacity-60 text-left">
                                            [[ card.description ]]
                                        </div>
                                    </div>
                                    <div class="text-xs">
                                        <div v-if="card.cost">消耗: [[ card.cost ]]</div>
                                        <div v-if="card.power">威力: [[ card.power ]]</div>
                                        <div v-if="card.link" class="mt-1">
                                            <a :href="card.link" target="_blank" class="text-blue-200 hover:text-blue-100 underline text-xs">
                                                📖 介绍
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧操作面板 -->
            <div class="w-80 bg-black/20 backdrop-blur-md border-l border-white/10 p-6">
                <!-- 卡牌图鉴 -->
                <div class="mb-6">
                    <h3 class="text-white font-semibold mb-4">卡牌图鉴</h3>
                    <div class="bg-white/10 rounded-lg p-4 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-white/70">总卡牌数</span>
                            <span class="text-white">[[ totalCards ]]</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-white/70">已打出</span>
                            <span class="text-white">[[ playedCards ]]</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-white/70">剩余卡牌</span>
                            <span class="text-white">[[ totalCards - playedCards ]]</span>
                        </div>
                        <div class="w-full bg-white/20 rounded-full h-2 mt-2">
                            <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all" 
                                 :style="{width: (playedCards / totalCards * 100) + '%'}"></div>
                        </div>
                        <button @click="showCodex = true" class="w-full mt-3 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            查看图鉴
                        </button>
                    </div>
                </div>

                <!-- 游戏操作 -->
                <div class="mb-6">
                    <h3 class="text-white font-semibold mb-4">游戏操作</h3>
                    <div class="space-y-3">
                        <button @click="playSelectedCard" 
                                :disabled="!selectedCard || !selectedPosition || !isMyTurn || autoPlay"
                                class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white font-semibold py-3 px-4 rounded-lg hover:from-green-600 hover:to-blue-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                :class="{'tutorial-highlight': tutorialStep === 5}">
                            <i class="fas fa-play mr-2"></i>
                            出牌
                        </button>
                        <button @click="endTurn" 
                                :disabled="!isMyTurn || autoPlay"
                                class="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white font-semibold py-3 px-4 rounded-lg hover:from-orange-600 hover:to-red-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                :class="{'tutorial-highlight': tutorialStep === 6}">
                            <i class="fas fa-forward mr-2"></i>
                            结束回合
                        </button>
                        <button @click="surrender" 
                                :disabled="autoPlay"
                                class="w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold py-3 px-4 rounded-lg hover:from-gray-600 hover:to-gray-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-flag mr-2"></i>
                            投降
                        </button>
                    </div>
                </div>

                <!-- 游戏信息 -->
                <div class="mb-6">
                    <h3 class="text-white font-semibold mb-4 flex items-center">
                        <span class="mr-2">📊</span>游戏信息
                    </h3>
                    <div class="bg-white/10 rounded-lg p-4 space-y-3">
                        <!-- 基本信息 -->
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-white/70 flex items-center">
                                    <span class="mr-1">🔄</span>回合数
                                </span>
                                <span class="text-yellow-400 font-semibold" v-if="gameState">[[ gameState.turn || 1 ]]</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-white/70 flex items-center">
                                    <span class="mr-1">⏱️</span>当前阶段
                                </span>
                                <span class="text-blue-400 font-medium" v-if="gameState">[[ gameState.phase || '准备' ]]</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-white/70 flex items-center">
                                    <span class="mr-1">🎮</span>游戏状态
                                </span>
                                <span :class="getGameStatusColor()" v-if="gameState">[[ gameState.status || '进行中' ]]</span>
                            </div>
                        </div>
                        
                        <!-- 连接状态 -->
                        <div class="border-t border-white/20 pt-3">
                            <div class="flex justify-between text-sm">
                                <span class="text-white/70 flex items-center">
                                    <span class="mr-1">🌐</span>连接状态
                                </span>
                                <span :class="getConnectionStatusColor()">
                                    <span v-if="connectionStatus === 'connected'" class="flex items-center">
                                        <span class="w-2 h-2 bg-green-400 rounded-full mr-1 animate-pulse"></span>
                                        已连接
                                    </span>
                                    <span v-else-if="connectionStatus === 'connecting'" class="flex items-center">
                                        <span class="w-2 h-2 bg-yellow-400 rounded-full mr-1 animate-pulse"></span>
                                        连接中
                                    </span>
                                    <span v-else class="flex items-center">
                                        <span class="w-2 h-2 bg-red-400 rounded-full mr-1"></span>
                                        已断开
                                    </span>
                                </span>
                            </div>
                        </div>
                        
                        <!-- 玩家状态 -->
                        <div class="border-t border-white/20 pt-3" v-if="gameState && gameState.players">
                            <div class="text-white/70 text-xs mb-2">在线玩家</div>
                            <div class="grid grid-cols-2 gap-2">
                                <div v-for="player in Object.values(gameState.players)" :key="player.id" 
                                     class="bg-white/5 rounded-lg p-2 text-xs">
                                    <div class="flex items-center justify-between">
                                        <span class="text-white font-medium truncate">[[ player.name ]]</span>
                                        <span :class="player.online ? 'text-green-400' : 'text-red-400'">
                                            <span v-if="player.online">●</span>
                                            <span v-else>○</span>
                                        </span>
                                    </div>
                                    <div class="text-white/60 mt-1">
                                        <span v-if="player.health !== undefined">❤️ [[ player.health ]]</span>
                                        <span v-if="player.energy !== undefined" class="ml-2">⚡ [[ player.energy ]]</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 玩家操作记录 -->
                <div class="mb-6">
                    <h3 class="text-white font-semibold mb-4">玩家操作记录</h3>
                    <div class="bg-white/10 rounded-lg p-4 h-64 overflow-y-auto">
                        <div v-for="(record, index) in playerActionRecords" :key="index" 
                             class="mb-2 p-2 bg-white/5 rounded text-sm">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-white font-medium">[[ record.playerName ]]</span>
                                <span class="text-white/50 text-xs">[[ formatTime(record.timestamp) ]]</span>
                            </div>
                            <div class="text-white/80">
                                <span class="text-blue-300">[[ record.action ]]</span>
                                <span v-if="record.cardName" class="ml-2">- [[ record.cardName ]]</span>
                                <span v-if="record.position" class="ml-2">位置: [[ record.position ]]</span>
                            </div>
                            <div v-if="record.result" class="text-green-300 text-xs mt-1">
                                结果: [[ record.result ]]
                            </div>
                        </div>
                        <div v-if="!playerActionRecords || playerActionRecords.length === 0" 
                             class="text-white/50 text-center py-8">
                            暂无操作记录
                        </div>
                    </div>
                </div>

                <!-- 游戏日志 -->
                <div class="mb-6">
                    <h3 class="text-white font-semibold mb-4">游戏日志</h3>
                    <div class="bg-white/10 rounded-lg p-4 h-48 overflow-y-auto">
                        <div v-for="log in gameLogs" :key="log.id" class="text-sm mb-2 pb-2 border-b border-white/10 last:border-b-0">
                            <div class="flex justify-between items-center">
                                <p class="text-white/90">
                                    <span class="font-bold text-yellow-400">[[ log.player_name ]]</span>
                                    <span class="text-blue-300 ml-2">[[ log.action.toLowerCase().replace('_', ' ') ]]</span>
                                </p>
                                <span class="text-white/50 text-xs">[[ new Date(log.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) ]]</span>
                            </div>
                            <div v-if="log.data && log.data.card_id" class="text-white/70 text-xs mt-1">
                                卡牌: [[ getCardName(log.data.card_id) || log.data.card_id ]]
                                <span v-if="log.data.position !== undefined">, 位置: [[ log.data.position ]]</span>
                            </div>
                            <div v-if="log.result" class="text-green-300 text-xs mt-1">
                                结果: [[ log.result ]]
                            </div>
                        </div>
                        <div v-if="!gameLogs || gameLogs.length === 0" 
                             class="text-white/50 text-center py-8">
                            等待游戏开始...
                        </div>
                    </div>
                </div>

                <!-- 聊天区域 -->
                <div>
                    <h3 class="text-white font-semibold mb-4">聊天</h3>
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="h-32 overflow-y-auto mb-3 space-y-2">
                            <div v-for="message in chatMessages" :key="message.id" class="text-sm leading-relaxed">
                                <span class="text-white/50 text-xs mr-2">[[ new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) ]]</span>
                                <span class="font-medium text-yellow-300">[[ message.player ]]:</span>
                                <span class="text-white ml-1">[[ message.text ]]</span>
                            </div>
                        </div>
                        <div class="flex">
                            <input v-model="newMessage" 
                                   @keyup.enter="sendMessage"
                                   placeholder="输入消息..."
                                   class="flex-1 bg-white/20 text-white placeholder-white/50 px-3 py-2 rounded-l-lg border-none outline-none">
                            <button @click="sendMessage" 
                                    class="bg-blue-500 text-white px-4 py-2 rounded-r-lg hover:bg-blue-600 transition-colors">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 易经教育功能 -->
                <div class="mt-6">
                    <h3 class="text-white font-semibold mb-4">
                        <i class="fas fa-graduation-cap mr-2"></i>易经智慧
                    </h3>
                    <div class="bg-white/10 rounded-lg p-4">
                        <!-- 卦象知识 -->
                        <div v-if="selectedCard" class="mb-4">
                            <h4 class="text-yellow-400 font-medium mb-2">当前卦象：[[ selectedCard.name ]]</h4>
                            <div class="text-white/80 text-sm space-y-2">
                                <p><strong>卦象含义：</strong>[[ getHexagramMeaning(selectedCard.name) ]]</p>
                                <p><strong>人生启示：</strong>[[ getLifeWisdom(selectedCard.name) ]]</p>
                                <p><strong>策略建议：</strong>[[ getStrategyAdvice(selectedCard.name) ]]</p>
                            </div>
                        </div>
                        
                        <!-- 八卦位置知识 -->
                        <div v-if="selectedBagua" class="mb-4">
                            <h4 class="text-green-400 font-medium mb-2">当前位置：[[ getBaguaName(selectedBagua) ]]</h4>
                            <div class="text-white/80 text-sm space-y-2">
                                <p><strong>方位属性：</strong>[[ getBaguaDirection(selectedBagua) ]]</p>
                                <p><strong>五行属性：</strong>[[ getBaguaElement(selectedBagua) ]]</p>
                                <p><strong>象征意义：</strong>[[ getBaguaSymbol(selectedBagua) ]]</p>
                            </div>
                        </div>
                        
                        <!-- 阴阳平衡知识 -->
                        <div class="mb-4">
                            <h4 class="text-purple-400 font-medium mb-2">阴阳平衡智慧</h4>
                            <div class="text-white/80 text-sm space-y-2">
                                <p><strong>当前状态：</strong>
                                    <span v-if="gameState">
                                        阴气 [[ gameState.yin ]] / 阳气 [[ gameState.yang ]]
                                        <span :class="getBalanceStatus().class">[[ getBalanceStatus().text ]]</span>
                                    </span>
                                </p>
                                <p><strong>平衡原理：</strong>阴阳相互依存，过阴则阳生，过阳则阴长</p>
                                <p><strong>游戏策略：</strong>[[ getBalanceAdvice() ]]</p>
                            </div>
                        </div>
                        
                        <!-- 每日易经 -->
                        <div>
                            <h4 class="text-blue-400 font-medium mb-2">今日易经</h4>
                            <div class="text-white/80 text-sm">
                                <p class="italic">"[[ dailyWisdom.quote ]]"</p>
                                <p class="mt-2 text-white/60">—— [[ dailyWisdom.source ]]</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tutorial Overlay -->
        <div v-if="tutorialActive" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-8" @click.self="exitTutorial">
            <div class="bg-gray-800 text-white rounded-lg shadow-xl p-6 max-w-lg text-center">
                <h3 class="text-2xl font-bold text-yellow-400 mb-4">游戏教学：第 [[ tutorialStep ]] 步</h3>
                <p class="mb-6 text-lg">[[ tutorialMessages[tutorialStep - 1] ]]</p>
                <div class="flex justify-center space-x-4">
                    <button @click="exitTutorial" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors">退出教学</button>
                    <button v-if="tutorialStep < tutorialMessages.length" @click="nextTutorialStep" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">下一步</button>
                    <button v-else @click="exitTutorial" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors">完成</button>
                </div>
            </div>
        </div>

        <!-- 底部手牌区域 -->
        <div class="bg-black/20 backdrop-blur-md border-t border-white/10 p-4">
            <div class="max-w-7xl mx-auto">
                <!-- 当前玩家手牌 -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-white font-semibold">手牌</h3>
                        <div class="text-white/70 text-sm">
                            <span v-if="activePlayer">气: [[ activePlayer.qi || 0 ]]</span>
                            <span class="mx-2">|</span>
                            <span v-if="activePlayer">道行: [[ activePlayer.dao_xing || 0 ]]</span>
                            <span class="mx-2">|</span>
                            <span v-if="activePlayer">诚意: [[ activePlayer.cheng_yi || 0 ]]</span>
                        </div>
                    </div>
                    
                    <!-- 手牌显示 -->
                    <div class="flex space-x-2 overflow-x-auto pb-2">
                        <div v-for="(card, index) in (activePlayer?.hand || [])" :key="index"
                             class="card-in-hand flex-shrink-0 bg-white/10 rounded-lg p-3 cursor-pointer hover:bg-white/20 transition-colors border-2 min-w-[200px]"
                             :class="{ 'border-yellow-400': selectedCard === index, 'border-white/30': selectedCard !== index }"
                             @click="selectCard(index)">
                            <div class="text-white font-bold text-sm mb-1">[[ card.name ]]</div>
                            <div class="text-white/70 text-xs mb-1">
                                [[ card.type ]]
                                <span v-if="card.category" class="text-yellow-300">([[ card.category ]])</span>
                            </div>
                            <div class="text-green-400 text-xs mb-1">属性: [[ card.element ]]</div>
                            <div class="text-blue-400 text-xs mb-1">消耗: [[ card.cost ]]气 | 威力: [[ card.power ]]</div>
                            <div class="text-white/60 text-xs mb-2">[[ card.description ]]</div>
                            <div class="text-orange-300 text-xs mb-2">效果: [[ card.effect ]]</div>
                            <div v-if="card.link" class="text-xs">
                                <a :href="card.link" target="_blank" class="text-blue-300 hover:text-blue-200 underline">
                                    📖 详细介绍
                                </a>
                            </div>
                        </div>
                        
                        <!-- 空手牌提示 -->
                        <div v-if="!activePlayer?.hand || activePlayer.hand.length === 0"
                             class="text-white/50 text-center py-8 flex-1">
                            暂无手牌
                        </div>
                    </div>
                </div>
                
                <!-- 游戏控制按钮 -->
                <div class="flex justify-center space-x-4">
                    <button @click="meditation" 
                            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        冥想 (+1气)
                    </button>
                    <button @click="study" 
                            class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors">
                        研习 (+1道行)
                    </button>
                    <button @click="checkGameEnd" 
                            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                        检查胜利
                    </button>
                    <button @click="nextTurn" 
                            class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
                        结束回合
                    </button>
                </div>
            </div>
        </div>

        <!-- 游戏结束模态框 -->
        <div v-if="showGameEnd" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
                <div class="text-center">
                    <div class="text-6xl mb-4">
                        <span v-if="gameResult === 'win'">🎉</span>
                        <span v-else-if="gameResult === 'lose'">😢</span>
                        <span v-else>🤝</span>
                    </div>
                    <h2 class="text-2xl font-bold mb-4">
                        <span v-if="gameResult === 'win'">恭喜获胜！</span>
                        <span v-else-if="gameResult === 'lose'">遗憾失败</span>
                        <span v-else>平局</span>
                    </h2>
                    <div class="space-y-3">
                        <button @click="playAgain" class="w-full bg-blue-500 text-white py-3 px-6 rounded-lg hover:bg-blue-600 transition-colors">
                            再来一局
                        </button>
                        <button @click="backToHome" class="w-full bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 transition-colors">
                            返回主页
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 加载遮罩 -->
        <div v-if="isLoading" class="fixed inset-0 bg-black/50 flex items-center justify-center z-40">
            <div class="bg-white rounded-lg p-6 text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <div class="text-gray-700">加载中...</div>
            </div>
        </div>

        <!-- 操作反馈提示 -->
        <div v-if="feedbackMessage" 
             :class="['fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 transform',
                     feedbackType === 'success' ? 'bg-green-500 text-white' : 
                     feedbackType === 'error' ? 'bg-red-500 text-white' : 
                     feedbackType === 'warning' ? 'bg-yellow-500 text-black' : 
                     'bg-blue-500 text-white']">
            <div class="flex items-center">
                <span class="mr-2">
                    <span v-if="feedbackType === 'success'">✅</span>
                    <span v-else-if="feedbackType === 'error'">❌</span>
                    <span v-else-if="feedbackType === 'warning'">⚠️</span>
                    <span v-else>ℹ️</span>
                </span>
                <span>[[ feedbackMessage ]]</span>
                <button @click="clearFeedback" class="ml-3 text-white/80 hover:text-white">
                    ✕
                </button>
            </div>
        </div>

        <!-- 操作确认对话框 -->
        <div v-if="showConfirmDialog" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
                <div class="text-center">
                    <div class="text-4xl mb-4">[[ confirmDialog.icon ]]</div>
                    <h3 class="text-xl font-bold mb-2">[[ confirmDialog.title ]]</h3>
                    <p class="text-gray-600 mb-6">[[ confirmDialog.message ]]</p>
                    <div class="flex space-x-3">
                        <button @click="cancelConfirm" 
                                class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                            取消
                        </button>
                        <button @click="executeConfirm" 
                                :class="['flex-1 py-2 px-4 rounded-lg transition-colors text-white',
                                        confirmDialog.type === 'danger' ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600']">
                            确认
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作提示浮层 -->
        <div v-if="actionHint" 
             class="fixed bottom-20 left-1/2 transform -translate-x-1/2 z-40 bg-black/80 text-white px-4 py-2 rounded-lg text-sm">
            <div class="flex items-center">
                <span class="mr-2">💡</span>
                <span>[[ actionHint ]]</span>
            </div>
        </div>

        <!-- Card Codex Modal -->
        <div v-if="showCodex" class="codex-modal" @click.self="showCodex = false">
            <div class="codex-modal-content">
                <span class="codex-close-btn" @click="showCodex = false">&times;</span>
                <h2 class="text-2xl font-bold mb-4">卡牌图鉴</h2>
                <div class="codex-tabs">
                    <button @click="codexFilter = 'all'" :class="['codex-tab-link', { 'active': codexFilter === 'all' }]">所有</button>
                    <button @click="codexFilter = 'gua'" :class="['codex-tab-link', { 'active': codexFilter === 'gua' }]">卦象</button>
                    <button @click="codexFilter = 'tian'" :class="['codex-tab-link', { 'active': codexFilter === 'tian' }]">天时</button>
                    <button @click="codexFilter = 'di'" :class="['codex-tab-link', { 'active': codexFilter === 'di' }]">地利</button>
                    <button @click="codexFilter = 'ren'" :class="['codex-tab-link', { 'active': codexFilter === 'ren' }]">人和</button>
                </div>
                <div class="codex-grid">
                    <div v-for="card in filteredCodexCards" :key="card.id" class="codex-card">
                        <div>
                            <div class="card-name">[[ card.name ]]</div>
                            <div class="card-type">[[ card.type ]] - [[ card.element ]]</div>
                            <div class="card-desc">[[ card.description ]]</div>
                        </div>
                        <div class="card-cost-power">消耗: [[ card.cost ]] | 威力: [[ card.power ]]</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        
        const app = createApp({
            delimiters: ['[[', ']]'],
            data() {
                return {
                    // Core State
                    gameState: null,
                    myPlayerId: null,
                    gameId: null,
                    websocket: null,

                    // UI State
                    showCodex: false,
                    codexFilter: 'all',
                    allCards: [],
                    selectedCard: null,
                    selectedPosition: null,
                    isLoading: true,
                    connectionStatus: 'connecting', // connecting, connected, disconnected

                    // Feedback & Dialogs
                    feedbackMessage: '',
                    feedbackType: 'info',
                    feedbackTimeout: null,
                    showConfirmDialog: false,
                    confirmDialog: { title: '', message: '', onConfirm: null },
                    actionHint: '',
                    hintTimeout: null,

                    // Chat & Logs
                    chatMessages: [],
                    newMessage: '',
                    gameLogs: [],

                    // Tutorial State
                    tutorialActive: false,
                    tutorialStep: 0,
                    tutorialMessages: [
                        "欢迎来到天机变教学！这是一个融合了易经智慧的策略游戏。",
                        "这是九宫格棋盘，游戏的核心区域。你需要在这里打出卡牌。",
                        "这是你的手牌区域。点击卡牌可以选中它。",
                        "打出卡牌需要消耗‘气’。请注意你的资源。",
                        "现在，请尝试选择一张手牌，然后点击棋盘上的一个位置，最后点击‘出牌’按钮。",
                        "干得好！你已经学会了基本操作。点击‘结束回合’来完成你的回合。",
                        "恭喜你完成教学！现在你可以自由探索了。"
                    ]
                };
            },
            computed: {
                activePlayer() {
                    if (!this.gameState || !this.gameState.current_player_id) return null;
                    return this.gameState.players[this.gameState.current_player_id];
                },
                isMyTurn() {
                    return this.activePlayer && this.activePlayer.id === this.myPlayerId;
                },
                playerHand() {
                    if (!this.gameState || !this.myPlayerId || !this.gameState.players[this.myPlayerId]) {
                        return [];
                    }
                    return this.gameState.players[this.myPlayerId].hand;
                },
                otherPlayers() {
                    if (!this.gameState || !this.gameState.players) return [];
                    return Object.values(this.gameState.players).filter(p => p.id !== this.myPlayerId);
                },
                filteredCodexCards() {
                    if (this.codexFilter === 'all') return this.allCards;
                    const filterMap = {
                        'gua': '六十四卦',
                        'tian': '天时卡',
                        'di': '地利卡',
                        'ren': '人和卡'
                    };
                    return this.allCards.filter(card => card.type === filterMap[this.codexFilter]);
                }
            },
            async mounted() {
                console.log('Vue app mounted. Initializing game...');
                await this.loadInitialData();
                this.initializeGame();
            },
            methods: {
                async loadInitialData() {
                    try {
                        const response = await fetch('/static/data/cards.json');
                        if (!response.ok) throw new Error('Failed to load card data');
                        this.allCards = await response.json();
                        console.log('Card codex loaded.');
                    } catch (error) {
                        console.error("Could not load card data:", error);
                        this.showFeedback('无法加载卡牌数据!', 'error');
                    }
                },
                initializeGame() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const playerIdFromUrl = urlParams.get('player_id');
                    const pathParts = window.location.pathname.split('/');
                    this.gameId = pathParts[pathParts.length - 1];

                    if (playerIdFromUrl) {
                        this.myPlayerId = playerIdFromUrl;
                        sessionStorage.setItem(`player_id_${this.gameId}`, playerIdFromUrl);
                        // Clean the URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } else {
                        this.myPlayerId = sessionStorage.getItem(`player_id_${this.gameId}`);
                    }

                    if (this.gameId && this.myPlayerId) {
                        this.initWebSocket();
                    } else {
                        console.log("No game/player ID found. Waiting for user to join or create a game.");
                        this.isLoading = false;
                    }
                },
                initWebSocket() {
                    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${wsProtocol}//${window.location.host}/ws/${this.gameId}/${this.myPlayerId}`;

                    this.websocket = new WebSocket(wsUrl);

                    this.websocket.onopen = () => {
                        this.connectionStatus = 'connected';
                        this.showFeedback('成功连接到游戏', 'success');
                    };

                    this.websocket.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        console.log('Received message:', message.type, message);

                        switch (message.type) {
                            case 'game_state':
                            case 'game_update':
                                this.gameState = message.game_state || message.data;
                                this.isLoading = false;
                                // Assuming logs are part of the game state now
                                this.gameLogs = this.gameState.logs || [];
                                break;
                            case 'player_joined':
                                this.gameState = message.game_state;
                                this.showFeedback(`${message.player.name} 加入了游戏`, 'info');
                                break;
                            case 'player_left':
                                this.showFeedback(`一位玩家离开了游戏`, 'warning');
                                if(this.gameState.players[message.player_id]) {
                                    this.gameState.players[message.player_id].online = false;
                                }
                                break;
                            case 'chat_message':
                                this.chatMessages.push(message.data);
                                this.$nextTick(() => {
                                    const chatBox = this.$el.querySelector('.h-32.overflow-y-auto');
                                    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
                                });
                                break;
                            case 'error':
                                this.showFeedback(`错误: ${message.detail}`, 'error');
                                break;
                        }
                    };

                    this.websocket.onclose = () => {
                        this.connectionStatus = 'disconnected';
                        this.showFeedback('与服务器断开连接', 'error');
                    };

                    this.websocket.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.connectionStatus = 'disconnected';
                        this.showFeedback('连接出现错误', 'error');
                    };
                },
                sendAction(actionType, data = {}) {
                    if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                        this.websocket.send(JSON.stringify({
                            action_type: actionType,
                            data: data
                        }));
                    } else {
                        this.showFeedback('与服务器的连接已断开', 'error');
                    }
                },
                selectCard(card) {
                    if (this.isMyTurn) {
                        this.selectedCard = card;
                        this.showHint('请在棋盘上选择一个位置出牌');
                    } else {
                        this.showFeedback('现在不是你的回合', 'warning');
                    }
                },
                selectBoardPosition(index) {
                    if (this.isMyTurn) {
                        this.selectedPosition = index;
                        this.showHint(`已选择位置 ${index}。再次点击卡牌或出牌按钮确认。`);
                    }
                },
                playSelectedCard() {
                    if (!this.selectedCard || this.selectedPosition === null) {
                        this.showFeedback('请先选择一张手牌和一个棋盘位置', 'warning');
                        return;
                    }
                    if (!this.isMyTurn) {
                        this.showFeedback('现在不是你的回合', 'error');
                        return;
                    }
                    this.sendAction('play_card', {
                        card_id: this.selectedCard.id,
                        position: this.selectedPosition
                    });
                    this.selectedCard = null;
                    this.selectedPosition = null;
                    this.showFeedback('出牌指令已发送', 'info', 1500);
                },
                endTurn() {
                    this.showConfirm('结束回合', '你确定要结束当前回合吗?', () => {
                        this.sendAction('end_turn');
                        this.showFeedback('结束回合指令已发送', 'info', 1500);
                    });
                },
                surrender() {
                     this.showConfirm('投降', '你确定要投降吗？这将立即结束游戏。', () => {
                        this.sendAction('surrender');
                        this.showFeedback('你已投降', 'info');
                    }, 'danger');
                },
                leaveGame() {
                    window.location.href = '/';
                },
                // UI and Feedback methods
                showFeedback(message, type = 'info', duration = 3000) {
                    this.feedbackMessage = message;
                    this.feedbackType = type;
                    if (this.feedbackTimeout) clearTimeout(this.feedbackTimeout);
                    this.feedbackTimeout = setTimeout(() => { this.feedbackMessage = ''; }, duration);
                },
                showConfirm(title, message, onConfirm, type = 'normal') {
                    this.confirmDialog = { title, message, onConfirm, type, icon: type === 'danger' ? '⚠️' : '❓' };
                    this.showConfirmDialog = true;
                },
                executeConfirm() {
                    if (this.confirmDialog.onConfirm) {
                        this.confirmDialog.onConfirm();
                    }
                    this.cancelConfirm();
                },
                cancelConfirm() {
                    this.showConfirmDialog = false;
                },
                showHint(message, duration = 2500) {
                    this.actionHint = message;
                    if (this.hintTimeout) clearTimeout(this.hintTimeout);
                    this.hintTimeout = setTimeout(() => { this.actionHint = ''; }, duration);
                },
                sendMessage() {
                    if (this.newMessage.trim() && this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                        this.sendAction('chat', { message: this.newMessage.trim() });
                        this.newMessage = '';
                    } else if (!this.websocket || this.websocket.readyState !== WebSocket.OPEN) {
                        this.showFeedback('无法发送消息，连接已断开', 'error');
                    }
                },
                // Helper methods for displaying data
                getCurrentPlayerName() {
                    if (!this.gameState || !this.gameState.current_player_id) return 'N/A';
                    const player = this.gameState.players[this.gameState.current_player_id];
                    return player ? player.name : '未知玩家';
                },
                getCurrentRound() {
                    return this.gameState?.turn || 'N/A';
                },
                getCurrentSeason() {
                    return this.gameState?.season || 'N/A';
                },
                getCurrentWuxing() {
                    // This is an example, assuming it comes from game state
                    return this.gameState?.dominant_element || 'N/A';
                },
                getCurrentGanzhi() {
                    return this.gameState?.ganzhi || 'N/A';
                },
                getCurrentJieqi() {
                    return this.gameState?.jieqi || 'N/A';
                },
                getCurrentYinyang() {
                    return this.gameState?.yinyang_state || '平衡';
                },
                getCurrentGameState() {
                    return this.gameState?.status || '未知';
                },
                getCardName(cardId) {
                    if (!this.allCards || this.allCards.length === 0) {
                        return cardId; // Return ID if cards are not loaded
                    }
                    const card = this.allCards.find(c => c.id === cardId);
                    return card ? card.name : cardId;
                },
                // Tutorial Methods
                startTutorial() {
                    this.tutorialActive = true;
                    this.tutorialStep = 1;
                },
                nextTutorialStep() {
                    if (this.tutorialStep < this.tutorialMessages.length) {
                        this.tutorialStep++;
                    } else {
                        this.exitTutorial();
                    }
                },
                exitTutorial() {
                    this.tutorialActive = false;
                    this.tutorialStep = 0;
                }
            }
        });
        
        window.vueApp = app.mount('#app');
    </script>
</body>
</html>